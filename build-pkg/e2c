#!/bin/bash

# e2c
# This script create a commit with the last EE changes in the merge-ee branch of the community repository.
# The script uses the current content of the EE repository, it does not use the last commit.


function msg() {
	echo -e "\n#### ${1} ####\n"
}



function print_usage_and_exit() {
	echo "Usage: $(basename "$0") [options]

	Options:
	--auto-merge		Apply automatly a commit in the CE branch 'merge-ee'"
	exit 1
}

while [ $# -gt 0 ]; do
	case $1 in
	--auto-merge)
		AUTO_MERGE=1
		;;
	*)
		echo "Invalid option: $1"
		print_usage_and_exit
		;;
	esac

	shift
done

CE_REPO="git@gitlab.zevenet.com:cristina.guerra/zevenet-ce.git"
CE_BRANCH="merge-ee"

zevenet_home='usr/local/zevenet'
BASE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"
com_dir=${BASE_DIR}/CE_WORKDIR
ent_dir=${BASE_DIR}/EE_WORKDIR
rsync_bin=`which rsync`

if [[ -z "$rsync_bin" ]]; then
	echo "ERROR: Please install rsync first. Thanks ;)"
	exit 1;
fi

# clone CE repository
msg "Cloning the community repository..."
rm -rf $com_dir
git clone $CE_REPO $com_dir
cd $com_dir
git fetch --all --tags --prune
git checkout $CE_BRANCH
cd ..


# get commit hash
EE_COMMIT=$(git log --oneline | head -1 | cut -d' ' -f1)

# Setup a clean EE environment
msg "Cleaning the EE directory..."
rm -rf $ent_dir
mkdir $ent_dir
$rsync_bin -a --exclude "/$(basename "$BASE_DIR")" ../* $ent_dir/


# load files
source config

msg "Copying EE files..."
# remove EE files
for file in "${encrypted_files[@]}"; do
		rm -rf ${ent_dir}/$file
done
for file in "${enterprise_files[@]}"; do
	rm -rf ${ent_dir}/$file
done

# copy community files
for file in "${community_files[@]}"; do
	if [ -e "${com_dir}/$file" ]; then
		cp ${com_dir}/$file ${ent_dir}/$(dirname $file)
	else
		echo "The CE file/dir is not found: ${ent_dir}/$file"
	fi
done

# keep the CE build-pkg dir
rm -rf ${ent_dir}/build-pkg
cp -r ${com_dir}/build-pkg ${ent_dir}

# keep the CE DEBIAN dir
rm -rf ${ent_dir}/DEBIAN
cp -r ${com_dir}/DEBIAN ${ent_dir}

# clean the CE to detect if a file has been deleted
rm -rf ${com_dir}/*

# copy all EE to the CE
cp -r ${ent_dir}/* $com_dir


# apply the commit to CE
if [ $AUTO_MERGE ]; then
	DATE=$(date +%H:%M:%S_%d/%m/%y)
	cd $com_dir

	git config user.email "devel@zevenet.com"
	git config user.name "AutoCommit"

	git add .
	git commit -m "[auto_merge] EE commit: $EE_COMMIT, date: $DATE"
	git push
fi

