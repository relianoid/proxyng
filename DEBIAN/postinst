#!/bin/bash
###############################################################################
#
#    Zevenet Software License
#    This file is part of the Zevenet Load Balancer software package.
#
#    Copyright (C) 2014-today ZEVENET SL, Sevilla (Spain)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
###############################################################################

BM_tag=0 # _BM_tag_

GLOBALCF="/usr/local/zevenet/config/global.conf"
GLOBALCFT="/usr/local/zevenet/share/global.conf.template"

[ ! "$1" == "configure" ] && echo "Installation aborted $1 $2" && exit 1
[ "$1" == "configure" ] && echo "Completing the Zevenet installation..."

# link l4xnat with iptables or nftables
if [ -d "/usr/share/perl5/Zevenet/Farm/L4xNAT" ]; then
	rm -rf "/usr/share/perl5/Zevenet/Farm/L4xNAT"
	ln -sf L4ipt /usr/share/perl5/Zevenet/Farm/L4xNAT
fi

# Check for binaries
PERLVER=`dpkg -l perl | grep perl | cut -d. -f-2 | xargs | cut -d\  -f3`
compiled_files=(
	/usr/local/zevenet/bin/zevenet
	/usr/local/zevenet/bin/enterprise.bin
)
for i in ${compiled_files[@]}
do
	if [ -e ${i}.${PERLVER} ]; then
		mv ${i}.${PERLVER} ${i}
		rm ${i}.*
	fi
done

#upgrading global.conf
/usr/local/zevenet/bin/checkglobalconf

# Enable root access through SSH
SSHDCONFIG="/etc/ssh/sshd_config"
if [[ `grep -c "^PermitRootLogin.*yes" $SSHDCONFIG` == '0' ]]; then
	sed -i -e 's/^PermitRootLogin.*/PermitRootLogin yes/' $SSHDCONFIG
	/etc/init.d/ssh reload 2> /dev/null
fi

# Set crontab
if [ ! -f /etc/cron.d/zevenet ]; then
	cp /usr/local/zevenet/share/zevenet.cron /etc/cron.d/zevenet
else
	sed -i 's!zevenet/app/zenrrd/zenrrd.pl!zevenet/bin/zenrrd!' /etc/cron.d/zevenet
	sed -i 's!zevenet/app/zenntp/zenntp.pl!zevenet/bin/zenntp!' /etc/cron.d/zevenet
fi

# Migrate keepalived.conf
if [ -f /etc/keepalived/keepalived.conf ]; then
	sed -i 's"/usr/local/zevenet/bin/enterprise.bin zcluster-manager"/usr/local/zevenet/bin/zcluster-manager"' /etc/keepalived/keepalived.conf

	if [[ `pgrep keepalived` ]]; then
		/etc/init.d/keepalived reload;
	fi
fi

# Disable conntrackd stats
sed -i '/Stats/,/}/d' /etc/conntrackd/conntrackd.conf 2>/dev/null
# Delete old conntrackd-stats logs
rm -rf /var/log/conntrackd-stats* 2>/dev/null

## Disable services

# SNMP services
if [[ -f /etc/snmp/snmpd.conf && `grep -c '#zenlb' /etc/snmp/snmpd.conf` == '0' ]]; then
	cp /usr/local/zevenet/share/snmpd.conf.template /etc/snmp/snmpd.conf
fi
if [[ `grep -c 'Lsd' /etc/default/snmpd` == '1' ]]; then
        sed -i -e 's/Lsd/LS6d/' /etc/default/snmpd
fi

# Disable systemd-sysctl
systemctl disable systemd-sysctl
systemctl mask systemd-sysctl.service
systemctl daemon-reload

# Disable apt-daily.timer
systemctl stop apt-daily.timer
systemctl disable apt-daily.timer
systemctl mask apt-daily.service
systemctl daemon-reload

# Disable OpenVZ (arpsend)
systemctl stop vz
systemctl disable vz 2>/dev/null
systemctl mask vz.service
systemctl daemon-reload

# Disable vzeventd
systemctl stop vzeventd
systemctl disable vzeventd 2>/dev/null
systemctl mask vzeventd.service
systemctl daemon-reload

# sec service for zevenet notifications
if [ -f /bin/systemctl ]
then
	systemctl stop sec 2>/dev/null
	systemctl disable sec 2>/dev/null
	systemctl stop systemd-timesyncd 2>/dev/null
	systemctl disable systemd-timesyncd 2>/dev/null
else
	/etc/init.d/sec stop > /dev/null
	insserv -r sec
fi

# keepalived service for zevenet cluster
if [ -f /bin/systemctl ]
then
	systemctl disable keepalived 2>/dev/null
else
	insserv -r keepalived
fi

# Do not load init-functions on keepalived service
# This allows keepalived to stop correctly
sed -i -e 's!^. /lib/lsb/init-functions!#. /lib/lsb/init-functions!' /etc/init.d/keepalived
sed -i -e 's!\slog_!: #log_!' /etc/init.d/keepalived

# Do not mount /usr/local/zevenet/logs for zlb 4000 series
sed -i 's/^\/dev\/mapper\/zva64-log \/usr\/local\/zevenet\/logs        ext4    defaults        0       2//' /etc/fstab

# boot dependencies
sed -i 's/^\# Required-Start:.*/# Required-Start:\t\$remote_fs \$syslog zevenet/g' /etc/init.d/ssh
sed -i 's/^\# Required-Stop:.*/# Required-Stop:\t\$remote_fs \$syslog zevenet/g' /etc/init.d/ssh

# Move zlb-stop & zlb-start. They were moved in the preinst
if [ -f /tmp/zlb-stop ]; then
	mv /tmp/zlb-stop /usr/local/zevenet/config/
fi
if [ -f /tmp/zlb-start ]; then
	mv /tmp/zlb-start /usr/local/zevenet/config/
fi

chmod +x /usr/local/zevenet/config/zlb-start
chmod +x /usr/local/zevenet/config/zlb-stop

# Disable DNS resolution for SSH service
if [ -f /usr/local/zevenet/bin/ssh_nodns.sh ]; then
	/usr/local/zevenet/bin/ssh_nodns.sh
fi

# Create IPDS directories
/usr/local/zevenet/bin/boot_ipds

# Remove residual cluster DROP(s) on ip6tables
if [ $BM_tag -ne 0 ]; then
	ip6tables -F INPUT 2>/dev/null
fi

# Apply all migrating scripts to zevenet
if [ $BM_tag -ne 0 ]; then
	#migrating config files
	MIG_DIR="/usr/local/zevenet/migrating/"
	for SCRIPT in `ls $MIG_DIR`; do ${MIG_DIR}$SCRIPT; done
fi

if [ $BM_tag -eq 0 ]; then
	# restarting zevenet service
	echo "Zevenet will be unavailable while the service is restarting."
	/etc/init.d/zevenet stop
	/etc/init.d/zevenet start
fi

# Load conntrack modules
/sbin/modprobe nf_conntrack 2> /dev/null
/sbin/modprobe ip_conntrack 2> /dev/null

# Add Zevenet services to boot process including dependencies
update-rc.d zevenet defaults

# Link zenbui
if [ -f /usr/local/zevenet/bin/zenbui ];
then
	rm /usr/bin/zenbui 2>/dev/null
	ln -sf /usr/local/zevenet/bin/zenbui /usr/bin/zenbui
fi

# copy rbac roles template to config if they do not exist
TMPROLE="/usr/local/zevenet/share/rbac_roles"
CONFROLE="/usr/local/zevenet/config/rbac/roles"
for i in `ls $TMPROLE`
do
	FILE=`echo $i | sed "s,$TMPROLE,,"`
	if [ ! -f "${CONFROLE}/$FILE" ]
	then
		cp "$TMPROLE/$FILE" "$CONFROLE/$FILE"
	fi
done

#Change prompt color
sed -i "s/1;30m/0;37m/g" /etc/bash.bashrc 2> /dev/null

if [ $BM_tag -eq 1 ]; then
	#Flush apt sources
	echo > /etc/apt/sources.list

	echo "Zevenet Load Balancer installed..."
else
	echo "Zevenet Load Balancer update completed..."
fi
